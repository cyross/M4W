<html><head><meta http-equiv="content-type" content="text/html; charset=utf8"> <style>
	.KEYW {color: #933;}
	.COMM {color: #bbb; font-style: italic;}
	.NUMB {color: #393;}
	.STRN {color: #393;}
	.REGX {color: #339;}
	.line {border-right: 1px dotted #666; color: #666; font-style: normal;}
	</style></head><body><pre><span class='line'>  1</span> <span class="COMM">/**
<span class='line'>  2</span>  * @fileOverview Miyako4Web(Miyako for Web a.k.a M4W/m4w) Extend Sprite Extension&lt;br>
<span class='line'>  3</span>  * M4W用強化版スプライト対応拡張プラグイン
<span class='line'>  4</span>  * このファイルを読み込むと、window.m4wオブジェクトに以下のプロパティが追加される&lt;br>
<span class='line'>  5</span>  * window.m4w.SpriteEx&lt;br>
<span class='line'>  6</span>  * window.m4w.SpriteExRenderer&lt;br>
<span class='line'>  7</span>  * window.m4w.AssetsLoader.loaders.sprite_ex&lt;br>
<span class='line'>  8</span>  * AssetLoader.prototype.success関数の引数に以下のキーが追加される&lt;br>
<span class='line'>  9</span>  * &lt;table>
<span class='line'> 10</span>  * &lt;tr>&lt;th>Key&lt;/th>&lt;th>Value&lt;/th>&lt;/tr>
<span class='line'> 11</span>  * &lt;tr>&lt;td>sprite_ex&lt;/td>&lt;td>SpriteExオブジェクトの辞書オブジェクト&lt;/tr>
<span class='line'> 12</span>  * &lt;/table>
<span class='line'> 13</span>  * @example 実際のSpriteExを取得するときは以下の方法でアクセス可能&lt;br>
<span class='line'> 14</span>  * 例1)&lt;br>
<span class='line'> 15</span>  * function success(assets){&lt;br>
<span class='line'> 16</span>  *    var sprite = assets.sprite_ex.(id);&lt;br>
<span class='line'> 17</span>  * }&lt;br>
<span class='line'> 18</span>  * 例2)&lt;br>
<span class='line'> 19</span>  * function success(assets){&lt;br>
<span class='line'> 20</span>  *    var sprite = assets["sprite_ex"]["id"];&lt;br>
<span class='line'> 21</span>  * }&lt;br>
<span class='line'> 22</span>  * AssetsLoader.load関数の引数も以下のように拡張される&lt;br>
<span class='line'> 23</span>  * options.assets[].type には"sprite_ex"と指定する
<span class='line'> 24</span>  * options.assets[].その他 にはSpriteExクラスコンストラクタの引数と同じものを指定
<span class='line'> 25</span>  *
<span class='line'> 26</span>  * @name Miyako for Web(M4W) Sound extention
<span class='line'> 27</span>  * @author Cyross Makoto (サイロス誠)
<span class='line'> 28</span>  * @version 0.0.1
<span class='line'> 29</span>  * @revision 1
<span class='line'> 30</span>  * @require jQuery 1.9.0/2.0.0(or later)
<span class='line'> 31</span>  * @license MIT License (MITライセンス)
<span class='line'> 32</span>  */</span><span class="WHIT">
<span class='line'> 33</span> 
<span class='line'> 34</span> </span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">$</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 35</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'> 36</span>    * @constructor
<span class='line'> 37</span>    * @class スプライト用レンダリングメソッドを定義
<span class='line'> 38</span>    */</span><span class="WHIT">
<span class='line'> 39</span> </span><span class="WHIT">  </span><span class="NAME">SpriteExRenderer</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 40</span> </span><span class="WHIT">    </span><span class="NAME">this.name</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"Miyako4Web SpriteEx Renderer"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 41</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 42</span> 
<span class='line'> 43</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'> 44</span>    * 画面への描画を行う&lt;br>
<span class='line'> 45</span>    * 隠蔽中の時は描画しない&lt;br>
<span class='line'> 46</span>    * 次の順番で描画する
<span class='line'> 47</span>    * &lt;ul>
<span class='line'> 48</span>    * &lt;li>回転/拡大/縮小を行う(m11,m12,m21,m22,x,dx,y,dy)&lt;li>
<span class='line'> 49</span>    * &lt;li>描画位置をずらす(dx,dy)&lt;/li>
<span class='line'> 50</span>    * &lt;li>透明度を設定(a)&lt;/li>
<span class='line'> 51</span>    * &lt;li>画像を描画する(image,sx,sy,sw,sh,dw,dh)&lt;/li>
<span class='line'> 52</span>    * &lt;li>設定を元に戻す&lt;/li>
<span class='line'> 53</span>    * &lt;/ul>
<span class='line'> 54</span>    */</span><span class="WHIT">
<span class='line'> 55</span> </span><span class="WHIT">  </span><span class="NAME">SpriteExRenderer.default_render</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">context</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 56</span> </span><span class="WHIT">    </span><span class="NAME">context.save</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 57</span> </span><span class="WHIT">    </span><span class="NAME">context.translate</span><span class="PUNC">(</span><span class="NAME">this.x</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">this.tx</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.y</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">this.ty</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 58</span> </span><span class="WHIT">    </span><span class="NAME">context.rotate</span><span class="PUNC">(</span><span class="NAME">this.r</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 59</span> </span><span class="WHIT">    </span><span class="NAME">context.scale</span><span class="PUNC">(</span><span class="NAME">this.scx</span><span class="PUNC">,</span><span class="NAME">this.scy</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 60</span> </span><span class="WHIT">    </span><span class="NAME">context.translate</span><span class="PUNC">(</span><span class="PUNC">-</span><span class="NAME">this.tx</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NAME">this.ty</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 61</span> </span><span class="WHIT">    </span><span class="NAME">context.globalAlpha</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.a</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 62</span> </span><span class="WHIT">    </span><span class="NAME">context.drawImage</span><span class="PUNC">(</span><span class="NAME">this.image</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.sx</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.sy</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.sw</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.sh</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.dw</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.dh</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 63</span> </span><span class="WHIT">    </span><span class="NAME">context.setTransform</span><span class="PUNC">(</span><span class="NUMB">1</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 64</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 65</span> 
<span class='line'> 66</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'> 67</span>    * 画面への描画を行う&lt;br>
<span class='line'> 68</span>    * 隠蔽中の時は描画しない&lt;br>
<span class='line'> 69</span>    * 次の順番で描画する
<span class='line'> 70</span>    * &lt;ul>
<span class='line'> 71</span>    * &lt;li>画像を描画する(image)&lt;/li>
<span class='line'> 72</span>    * &lt;/ul>
<span class='line'> 73</span>    */</span><span class="WHIT">
<span class='line'> 74</span> </span><span class="WHIT">  </span><span class="NAME">SpriteExRenderer.fast_render</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">context</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 75</span> </span><span class="WHIT">    </span><span class="NAME">context.drawImage</span><span class="PUNC">(</span><span class="NAME">this.image</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.x</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.y</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 76</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 77</span> 
<span class='line'> 78</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'> 79</span>    * 画面への描画を行う&lt;br>
<span class='line'> 80</span>    * 隠蔽中の時は描画しない&lt;br>
<span class='line'> 81</span>    * 次の順番で描画する
<span class='line'> 82</span>    * &lt;ul>
<span class='line'> 83</span>    * &lt;li>透明度を設定(a)&lt;/li>
<span class='line'> 84</span>    * &lt;li>画像を描画する(image,sx,sy,sw,sh,dw,dh)&lt;/li>
<span class='line'> 85</span>    * &lt;/ul>
<span class='line'> 86</span>    */</span><span class="WHIT">
<span class='line'> 87</span> </span><span class="WHIT">  </span><span class="NAME">SpriteExRenderer.fast_render2</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">context</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 88</span> </span><span class="WHIT">    </span><span class="NAME">context.globalAlpha</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.a</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 89</span> </span><span class="WHIT">    </span><span class="NAME">context.drawImage</span><span class="PUNC">(</span><span class="NAME">this.image</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.sx</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.sy</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.sw</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.sh</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.x</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.y</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.dw</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.dh</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 90</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 91</span> 
<span class='line'> 92</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'> 93</span>    * @constructor
<span class='line'> 94</span>    * @class スプライトを管理・操作
<span class='line'> 95</span>    * @param options.id スプライトに一意に一位につけられるID&lt;br>省略時はvalue属性(Imageオブジェクト)のidプロパティ
<span class='line'> 96</span>    * @param options.value スプライトの元にするImageクラス(Javascript標準クラス)のオブジェクト
<span class='line'> 97</span>    * @param [options.x] ブロックの左端から右方向の位置(左端を0とする)&lt;br>省略時は0
<span class='line'> 98</span>    * @param [options.y] ブロックの左端から右方向の位置(左端を0とする)&lt;br>省略時は0
<span class='line'> 99</span>    * @param [options.a] 描画時の透明度&lt;br>0.0≦a≦1.0の間&lt;br>0.0で完全透明、1.0で完全不透明&lt;br>省略時は1.0
<span class='line'>100</span>    * @param [options.r] 回転角度&lt;br>単位はラジアン&lt;br>省略時は0.0
<span class='line'>101</span>    * @param [options.tx] 回転・拡大縮小の中心位置(x方向)&lt;br>省略時は画像の幅の半分
<span class='line'>102</span>    * @param [options.ty] 回転・拡大縮小の中心位置(y方向)&lt;br>省略時は画像の高さの半分
<span class='line'>103</span>    * @param [options.scx] 拡大率(x横方向)&lt;br>省略時は1.0
<span class='line'>104</span>    * @param [options.scy] 拡大率(y方向)&lt;br>省略時は1.0
<span class='line'>105</span>    * @param [options.sx] 画像内の右方向の描画開始位置&lt;br>省略時は0
<span class='line'>106</span>    * @param [options.sy] 画像内の下方向の描画開始位置
<span class='line'>107</span>    * @param [options.sw] 画像内の描画幅&lt;br>省略時は画像と同じ幅
<span class='line'>108</span>    * @param [options.sh] 画像内の描画高さ&lt;br>省略時は画像と同じ高さ
<span class='line'>109</span>    * @param [options.dx] レイヤ内の右方向の描画開始位置&lt;br>Sprite.xの位置より右にずれる&lt;br>省略時は0
<span class='line'>110</span>    * @param [options.dy] レイヤ内の下方向の描画開始位置&lt;br>Sprite.yの位置より下にずれる&lt;br>省略時は0
<span class='line'>111</span>    * @param [options.dw] レイヤ内の描画幅&lt;br>Sprite.swの値から拡大/縮小して描画される&lt;br>省略時はSprite.swと同じ値
<span class='line'>112</span>    * @param [options.dh] レイヤ内の描画高さ&lt;br>Sprite.shの値から拡大/縮小して描画される&lt;br>省略時はSprite.shと同じ値
<span class='line'>113</span>    */</span><span class="WHIT">
<span class='line'>114</span> </span><span class="WHIT">  </span><span class="NAME">SpriteEx</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">options</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>115</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">o</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">$.extend</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>116</span> </span><span class="WHIT">      </span><span class="NAME">id</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">options.value.id</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>117</span> </span><span class="WHIT">      </span><span class="NAME">x</span><span class="PUNC">:</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">y</span><span class="PUNC">:</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">a</span><span class="PUNC">:</span><span class="NUMB">1.0</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>118</span> </span><span class="WHIT">      </span><span class="NAME">r</span><span class="PUNC">:</span><span class="NUMB">0.0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">scx</span><span class="PUNC">:</span><span class="NUMB">1.0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">scy</span><span class="PUNC">:</span><span class="NUMB">1.0</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>119</span> </span><span class="WHIT">      </span><span class="NAME">tx</span><span class="PUNC">:</span><span class="NAME">options.value.width</span><span class="PUNC">/</span><span class="NUMB">2</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>120</span> </span><span class="WHIT">      </span><span class="NAME">ty</span><span class="PUNC">:</span><span class="NAME">options.value.height</span><span class="PUNC">/</span><span class="NUMB">2</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>121</span> </span><span class="WHIT">      </span><span class="NAME">sx</span><span class="PUNC">:</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">sy</span><span class="PUNC">:</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">sw</span><span class="PUNC">:</span><span class="NAME">options.value.width</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">sh</span><span class="PUNC">:</span><span class="NAME">options.value.height</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>122</span> </span><span class="WHIT">      </span><span class="NAME">dx</span><span class="PUNC">:</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dy</span><span class="PUNC">:</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dw</span><span class="PUNC">:</span><span class="NAME">options.value.width</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dh</span><span class="PUNC">:</span><span class="NAME">options.value.height</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">options</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>123</span> </span><span class="WHIT">    </span><span class="NAME">this.id</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">o.id</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>124</span> </span><span class="WHIT">    </span><span class="NAME">this.image</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">o.value</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>125</span> </span><span class="WHIT">    </span><span class="COMM">/** @property ブロックの左端から右方向の位置(左端を0とする) */</span><span class="WHIT">
<span class='line'>126</span> </span><span class="WHIT">    </span><span class="NAME">this.x</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">o.x</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>127</span> </span><span class="WHIT">    </span><span class="COMM">/** @property ブロックの左端から右方向の位置(左端を0とする) */</span><span class="WHIT">
<span class='line'>128</span> </span><span class="WHIT">    </span><span class="NAME">this.y</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">o.y</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>129</span> </span><span class="WHIT">    </span><span class="COMM">/** @property 描画時の透明度&lt;br>0≦a≦1の間&lt;br>0で完全透明、1で完全不透明 */</span><span class="WHIT">
<span class='line'>130</span> </span><span class="WHIT">    </span><span class="NAME">this.a</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">o.a</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>131</span> </span><span class="WHIT">    </span><span class="COMM">/** @property 回転角度&lt;br>単位はラジアン&lt;br>省略時は0.0 */</span><span class="WHIT">
<span class='line'>132</span> </span><span class="WHIT">    </span><span class="NAME">this.r</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">o.r</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>133</span> </span><span class="WHIT">    </span><span class="COMM">/** @property 拡大率(x横方向)&lt;br>省略時は1.0 */</span><span class="WHIT">
<span class='line'>134</span> </span><span class="WHIT">    </span><span class="NAME">this.scx</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">o.scx</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>135</span> </span><span class="WHIT">    </span><span class="COMM">/** @property 拡大率(y方向)&lt;br>省略時は1.0 */</span><span class="WHIT">
<span class='line'>136</span> </span><span class="WHIT">    </span><span class="NAME">this.scy</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">o.scy</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>137</span> </span><span class="WHIT">    </span><span class="COMM">/** @property 回転・拡大縮小の中心位置(x方向)&lt;br>省略時は画像の幅の半分 */</span><span class="WHIT">
<span class='line'>138</span> </span><span class="WHIT">    </span><span class="NAME">this.tx</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">o.tx</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>139</span> </span><span class="WHIT">    </span><span class="COMM">/** @property 回転・拡大縮小の中心位置(y方向)&lt;br>省略時は画像の高さの半分 */</span><span class="WHIT">
<span class='line'>140</span> </span><span class="WHIT">    </span><span class="NAME">this.ty</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">o.ty</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>141</span> </span><span class="WHIT">    </span><span class="COMM">/** @property 画像内の右方向の描画開始位置&lt;br>省略時は0 */</span><span class="WHIT">
<span class='line'>142</span> </span><span class="WHIT">    </span><span class="NAME">this.sx</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">o.sx</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>143</span> </span><span class="WHIT">    </span><span class="COMM">/** @property 画像内の下方向の描画開始位置 */</span><span class="WHIT">
<span class='line'>144</span> </span><span class="WHIT">    </span><span class="NAME">this.sy</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">o.sy</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>145</span> </span><span class="WHIT">    </span><span class="COMM">/** @property 画像内の描画幅&lt;br>省略時は画像と同じ幅 */</span><span class="WHIT">
<span class='line'>146</span> </span><span class="WHIT">    </span><span class="NAME">this.sw</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">o.sw</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>147</span> </span><span class="WHIT">    </span><span class="COMM">/** @property 画像内の描画高さ&lt;br>省略時は画像と同じ高さ */</span><span class="WHIT">
<span class='line'>148</span> </span><span class="WHIT">    </span><span class="NAME">this.sh</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">o.sh</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>149</span> </span><span class="WHIT">    </span><span class="COMM">/** @property 画面右方向の描画開始位置&lt;br>xの位置より右にずれる&lt;br>省略時は0 */</span><span class="WHIT">
<span class='line'>150</span> </span><span class="WHIT">    </span><span class="NAME">this.dx</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">o.dx</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>151</span> </span><span class="WHIT">    </span><span class="COMM">/** @property 画面下方向の描画開始位置&lt;br>yの位置より下にずれる&lt;br>省略時は0 */</span><span class="WHIT">
<span class='line'>152</span> </span><span class="WHIT">    </span><span class="NAME">this.dy</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">o.dy</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>153</span> </span><span class="WHIT">    </span><span class="COMM">/** @property 画面内の描画幅&lt;br>swの値から拡大/縮小して描画される&lt;br>省略時はswと同じ値 */</span><span class="WHIT">
<span class='line'>154</span> </span><span class="WHIT">    </span><span class="NAME">this.dw</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">o.dw</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>155</span> </span><span class="WHIT">    </span><span class="COMM">/** @property 画面内の描画高さ&lt;br>shの値から拡大/縮小して描画される&lt;br>省略時はshと同じ値 */</span><span class="WHIT">
<span class='line'>156</span> </span><span class="WHIT">    </span><span class="NAME">this.dh</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">o.dh</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>157</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>158</span> 
<span class='line'>159</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>160</span>    * 音声ファイルを読み込む&lt;br>audioタグを作り、再生ができるときに指定した関数を呼び出す
<span class='line'>161</span>    * @param options.id スプライトに一意に一位につけられるID&lt;br>内部で生成するImageオブジェクトも同じIDになる
<span class='line'>162</span>    * @param options.src 対象ファイルのURLを配列で指定(マルチブラウザ対応)
<span class='line'>163</span>    * @return スプライトを生成しているDeferredオブジェクト&lt;br>コールバック関数の引数は、{type: "sprite", id: options.id, value: 生成したImageオブジェクト. options: 生成時のオプション}で示すオブジェクト
<span class='line'>164</span>    */</span><span class="WHIT">
<span class='line'>165</span> </span><span class="WHIT">  </span><span class="NAME">SpriteEx.load</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">options</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>166</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">defer</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">$.Deferred</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>167</span> </span><span class="WHIT">    </span><span class="NAME">SpriteEx.load_image</span><span class="PUNC">(</span><span class="NAME">options</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">then</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">obj</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>168</span> </span><span class="WHIT">      </span><span class="NAME">defer.resolve</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="NAME">type</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">"sprite"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">obj.id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">SpriteEx</span><span class="PUNC">(</span><span class="NAME">$.extend</span><span class="PUNC">(</span><span class="NAME">options</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">obj</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">options</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">options</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>169</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>170</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">defer.promise</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>171</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>172</span> 
<span class='line'>173</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>174</span>    * @ignore
<span class='line'>175</span>    */</span><span class="WHIT">
<span class='line'>176</span> </span><span class="WHIT">  </span><span class="NAME">SpriteEx.load_image</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Sprite.load_image</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>177</span> 
<span class='line'>178</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>179</span>    * スプライトを描画する&lt;br>省略時はRenderer.default_render関数が指定される
<span class='line'>180</span>    * @param {Object} context 対象のレイヤー(canvasタグ)が持つコンテキスト
<span class='line'>181</span>    */</span><span class="WHIT">
<span class='line'>182</span> </span><span class="WHIT">  </span><span class="NAME">SpriteEx.prototype.render</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SpriteExRenderer.default_render</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>183</span> 
<span class='line'>184</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>185</span>    * スプライトを回転・拡大・縮小させる&lt;br>一旦指定すると、transformかreset_matrixメソッドを呼ばない限り、この値が有効に鳴る
<span class='line'>186</span>    * @param [options.deg] 回転させる角度&lt;br>単位:度&lt;br>省略時は0
<span class='line'>187</span>    * @param [options.sx] sx 横方向の拡大縮小割合(右への方向)&lt;br>省略時は1.0
<span class='line'>188</span>    * @param [options.sy] sy 縦方向の拡大縮小割合(下への方向)&lt;br>省略時は1.0
<span class='line'>189</span>    */</span><span class="WHIT">
<span class='line'>190</span> </span><span class="WHIT">  </span><span class="NAME">SpriteEx.prototype.transform</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">options</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>191</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">o</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">$.extend</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="NAME">deg</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">sx</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">1.0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">sy</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">1.0</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">options</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>192</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">rad</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">2.0</span><span class="WHIT"> </span><span class="PUNC">*</span><span class="WHIT"> </span><span class="NAME">o.deg</span><span class="WHIT"> </span><span class="PUNC">*</span><span class="WHIT"> </span><span class="NAME">Math.PI</span><span class="WHIT"> </span><span class="PUNC">/</span><span class="WHIT"> </span><span class="NUMB">360.0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>193</span> </span><span class="WHIT">    </span><span class="NAME">this.m11</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">o.sx</span><span class="WHIT"> </span><span class="PUNC">*</span><span class="WHIT"> </span><span class="NAME">Math.cos</span><span class="PUNC">(</span><span class="NAME">rad</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>194</span> </span><span class="WHIT">    </span><span class="NAME">this.m12</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">o.sx</span><span class="WHIT"> </span><span class="PUNC">*</span><span class="WHIT"> </span><span class="NAME">Math.sin</span><span class="PUNC">(</span><span class="NAME">rad</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>195</span> </span><span class="WHIT">    </span><span class="NAME">this.m21</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">o.sy</span><span class="WHIT"> </span><span class="PUNC">*</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">(</span><span class="NAME">Math.sin</span><span class="PUNC">(</span><span class="NAME">rad</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>196</span> </span><span class="WHIT">    </span><span class="NAME">this.m22</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">o.sy</span><span class="WHIT"> </span><span class="PUNC">*</span><span class="WHIT"> </span><span class="NAME">Math.cos</span><span class="PUNC">(</span><span class="NAME">rad</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>197</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>198</span> 
<span class='line'>199</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>200</span>    * transformメソッドで指定したか回転・拡大・縮小をリセット(回転0度、拡大1.0倍)する
<span class='line'>201</span>    */</span><span class="WHIT">
<span class='line'>202</span> </span><span class="WHIT">  </span><span class="NAME">SpriteEx.prototype.reset_matrix</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>203</span> </span><span class="WHIT">    </span><span class="NAME">this.m11</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1.0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>204</span> </span><span class="WHIT">    </span><span class="NAME">this.m12</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0.0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>205</span> </span><span class="WHIT">    </span><span class="NAME">this.m21</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0.0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>206</span> </span><span class="WHIT">    </span><span class="NAME">this.m22</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1.0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>207</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>208</span> 
<span class='line'>209</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>210</span>    * スプライトを移動させる&lt;br>座標は、ブロックの左上が(0,0)で、値がプラスだと右・下方向、マイナスだと左・上方向となる
<span class='line'>211</span>    * @param [options.x] 左端を0とした時の右方向の位置&lt;br>省略時は現在位置
<span class='line'>212</span>    * @param [options.y] 上端を0とした時の下方向の位置&lt;br>省略時は現在位置
<span class='line'>213</span>    * @param [options.dx] 右方向をプラスとした時の移動量&lt;br>省略時は0
<span class='line'>214</span>    * @param [options.dy] 下方向をプラスとした時の移動量&lt;br>省略時は0
<span class='line'>215</span>    */</span><span class="WHIT">
<span class='line'>216</span> </span><span class="WHIT">  </span><span class="NAME">SpriteEx.prototype.move</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">options</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>217</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">o</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">$.extend</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="NAME">x</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.x</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">y</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.y</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dx</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dy</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">options</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>218</span> </span><span class="WHIT">    </span><span class="NAME">this.x</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">o.x</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">o.dx</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>219</span> </span><span class="WHIT">    </span><span class="NAME">this.y</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">o.y</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">o.dy</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>220</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>221</span> 
<span class='line'>222</span> </span><span class="WHIT">  </span><span class="NAME">window.m4w</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">$.extend</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="NAME">SpriteEx</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">SpriteEx</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">SpriteExRenderer</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">SpriteExRenderer</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">window.m4w</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>223</span> 
<span class='line'>224</span> </span><span class="WHIT">  </span><span class="COMM">/** @ignore */</span><span class="WHIT">
<span class='line'>225</span> </span><span class="WHIT">  </span><span class="NAME">window.m4w.AssetsLoader.loaders.sprite_ex</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">options</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>226</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">SpriteEx.load</span><span class="PUNC">(</span><span class="NAME">options</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>227</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>228</span> </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">(</span><span class="NAME">jQuery</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>229</span> </span></pre></body></html>